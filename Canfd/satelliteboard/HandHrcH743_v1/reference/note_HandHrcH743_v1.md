# HandHrcH743_v1 — CAN-FD (FDCAN1) bring-up + 1kHz slave TX + IRQ RX print

This repo is an **STM32CubeIDE** project for **STM32H743ZITx (NUCLEO-144)** focused on bringing up **CAN-FD** (FDCAN1) and a simple software architecture for:

- **1 kHz periodic transmit** (slave status frame) driven by **TIM6 interrupt**
- **Interrupt-driven receive** via **FDCAN1 RX FIFO0** interrupt, with received frames printed via `printf()` (UART retarget)

The goal is to build a **stable “slave node” baseline** first, then implement a **master node** that sends commands and verifies the RX interrupt + parsing path.

---

## Hardware / wiring assumptions

- **Board**: STM32H743 NUCLEO-144
- **CAN transceiver**: external CAN-FD transceiver required (e.g., MCP2542)
- **Bus**: short wire (cm-level) and proper termination (120 Ω at both ends) when using 2 nodes.

---

## Pinout (current CubeMX settings)

### FDCAN1 (CAN-FD)
- **PD0**: `FDCAN1_RX`
- **PD1**: `FDCAN1_TX`

### USART3 (printf / debug)
- **PD8**: `USART3_TX`
- **PD9**: `USART3_RX`
- **Baud**: 115200 8N1 (generated by CubeMX in `MX_USART3_UART_Init()`)

> Note: the exact “PC terminal / USB-UART” wiring depends on your hardware. Ensure PD8/PD9 are routed to your USB-UART bridge / header you are using.

---

## Clocks / timing (intent)

This project configures:

- **FDCAN kernel clock**: intended 100 MHz (from PLL) in CubeMX
- **Nominal phase**: 1 Mbps (NomPrescaler=5, Seg1=13, Seg2=6, SJW=2)
- **Data phase**: 10 Mbps with BRS (DataPrescaler=1, Seg1=7, Seg2=2, SJW=2)

TIM6 is configured for **1 kHz** periodic interrupts:

- APB1 timer clock ~200 MHz (x2 timer rule)
- Prescaler = 19999, Period = 9 → 1 ms tick

---

## Software architecture (important)

### TX (1 kHz “slave status”)

- **TIM6 ISR** does **NOT** call CAN transmit functions.
- TIM6 ISR only sets a flag (`CANFD_Utils_On1kHzTickISR()`).
- Main loop checks `CANFD_Utils_Consume1kHzTick()` and then sends the CAN-FD frame.

Why: keep ISR short and predictable; avoid long HAL calls inside IRQ.

### RX (from master → slave)

- FDCAN hardware stores RX frames into **RX FIFO0**
- **FDCAN1 interrupt** triggers `HAL_FDCAN_IRQHandler()`
- HAL calls `HAL_FDCAN_RxFifo0Callback()` (implemented in `canfd_utils.c`)
- The callback copies the last received message into a small buffer and sets a flag
- Main loop checks `CANFD_Utils_RxPending()` and prints a short line via `printf()`

If **no other node transmits**, RX remains silent and the RX print will not appear (expected).

---

## Filters (current behavior)

Filters are configured in code in `CANFD_Utils_Init()`:

- **Standard ID range filter** accepting **0x000 .. 0x7FF** into **RX FIFO0**
- Global filter currently accepts non-matching frames to FIFO0 (for bring-up)

This is intentionally “accept all” for initial testing; later we should tighten filters by ID scheme.

---

## Key files and what they do

### CubeMX-generated core (do not hand-edit outside USER CODE blocks)

- `Core/Src/main.c`
  - Peripheral init order
  - Starts TIM6 interrupt
  - Runs main loop:
    - on 1 kHz tick → sends CAN-FD frame
    - on RX pending → prints RX info
  - Contains `HAL_TIM_PeriodElapsedCallback()` (TIM6 tick flag)

- `Core/Src/stm32h7xx_it.c`
  - IRQ handlers:
    - `FDCAN1_IT0_IRQHandler()` → `HAL_FDCAN_IRQHandler(&hfdcan1)`
    - `TIM6_DAC_IRQHandler()` → `HAL_TIM_IRQHandler(&htim6)`

- `Core/Src/stm32h7xx_hal_msp.c`
  - Low-level GPIO/clock/NVIC config for FDCAN1, TIM6, USART3

- `Core/Inc/stm32h7xx_hal_conf.h`
  - HAL module selection (enables FDCAN, TIM, UART, etc.)
  - This file is **regenerated** by CubeMX.

### Project utilities (safe to edit)

- `Core/Inc/canfd_utils.h`, `Core/Src/canfd_utils.c`
  - Runtime FDCAN init (filters, start, notifications)
  - TX helper for 48-byte CAN-FD frames containing `Motor_TxPDO_t` (36 bytes + padding)
  - RX callback and RX buffer/flag
  - TIM6 tick flag helpers

### printf retarget

- `Core/Src/syscalls.c`
  - `_write()` calls `__io_putchar()` repeatedly

- `Core/Src/retarget.c`
  - Implements `__io_putchar()` using `HAL_UART_Transmit(&huart3, ...)`
  - Requirement: **`MX_USART3_UART_Init()` must run before the first `printf()`**

---

## Current transmit ID scheme (placeholder)

The slave currently transmits:

- **StdID = `0x200 + 1` = `0x201`** at 1 kHz

This is a placeholder and should be aligned with the final multi-motor / multi-node ID map.

---

## Testing checklist (quick)

### Basic UART
- Confirm you see the startup `printf()` on your terminal (USART3).

### CAN-FD TX/RX (2 nodes)
- Wire transceivers and termination properly
- On the second board (master), transmit any standard ID frame
- This slave should print `CAN RX: StdId=...`
- Observe 1 kHz frames on the bus (scope / CAN analyzer / second MCU)

---

## References

- `reference/note_stm32H743NUCLEO144_CANFD.md` — deeper bring-up notes (timing math, design decisions).


